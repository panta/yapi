name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Install bats
      run: |
        git clone https://github.com/bats-core/bats-core.git
        cd bats-core && sudo ./install.sh /usr/local

    - name: Make scripts executable
      run: chmod +x yapi lib/*.sh

    - name: Run unit tests
      run: bats test/yapi_utils.bats test/yapi_config.bats test/yapi_http.bats

  integration-tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Install grpcurl
      run: sudo snap install --edge grpcurl

    - name: Install bats
      run: |
        git clone https://github.com/bats-core/bats-core.git
        cd bats-core && sudo ./install.sh /usr/local

    - name: Make scripts executable
      run: chmod +x yapi lib/*.sh

    - name: Run integration tests
      run: bats test/integration.bats

    - name: Test all examples
      run: ./scripts/run-all-examples.sh
