#!/bin/bash
# yapi - YAML API Testing Tool
# Main entry point
set -e

# Resolve script directory for sourcing libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source all library files
source "$SCRIPT_DIR/lib/yapi_utils.sh"
source "$SCRIPT_DIR/lib/yapi_config.sh"
source "$SCRIPT_DIR/lib/yapi_select.sh"
source "$SCRIPT_DIR/lib/yapi_http.sh"
source "$SCRIPT_DIR/lib/yapi_grpc.sh"
source "$SCRIPT_DIR/lib/yapi_tcp.sh"

# Default values
CONFIG=""
CLI_URL=""
USE_ALL_FILES=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -c|--config)
      if [[ -z "$2" ]] || [[ "$2" == -* ]]; then
        error_exit "Option $1 requires an argument"
      fi
      CONFIG="$2"
      shift 2
      ;;
    -u|--url)
      if [[ -z "$2" ]] || [[ "$2" == -* ]]; then
        error_exit "Option $1 requires an argument"
      fi
      CLI_URL="$2"
      shift 2
      ;;
    -a|--all)
      USE_ALL_FILES=true
      shift
      ;;
    -h|--help)
      show_help
      ;;
    -*)
      error_exit "Unknown option: $1"
      ;;
    *)
      error_exit "Unexpected argument: $1"
      ;;
  esac
done

# Handle config file selection
if [[ -z "$CONFIG" ]]; then
  CONFIG=$(select_config_file "$USE_ALL_FILES")
fi

# Validate config file
validate_config_file "$CONFIG"

# Parse common config values
parse_common_config "$CONFIG"

# Detect protocol
PROTOCOL=$(detect_protocol "$CONFIG_URL" "$CONFIG_METHOD")

# Parse protocol-specific config
case "$PROTOCOL" in
  grpc)
    parse_grpc_config "$CONFIG"
    ;;
  tcp)
    parse_tcp_config "$CONFIG"
    ;;
esac

# Determine final URL (CLI overrides config)
if [[ -n "$CLI_URL" ]]; then
  URL="$CLI_URL"
elif [[ -n "$CONFIG_URL" ]]; then
  URL="$CONFIG_URL"
else
  error_exit "URL is required: either provide 'url' in config file or use -u flag"
fi

# Log to history
log_history "$CONFIG" "$CLI_URL"

# Execute request based on protocol
case "$PROTOCOL" in
  http)
    execute_http_request "$CONFIG" "$URL"
    ;;
  grpc)
    execute_grpc_request "$CONFIG" "$URL"
    ;;
  tcp)
    execute_tcp_request "$CONFIG" "$URL"
    ;;
  *)
    error_exit "Unsupported protocol: $PROTOCOL"
    ;;
esac
