{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://pond.audio/yapi/schema",
  "title": "yapit Configuration",
  "description": "Schema for yapit YAML API testing configuration files (HTTP and gRPC)",
  "type": "object",
  "required": ["yapi", "url"],
  "properties": {
    "yapi": {
      "type": "string",
      "enum": ["v1"],
      "description": "The version of the yapi configuration schema"
    },
    "url": {
      "type": "string",
      "description": "Base URL for the API request. Use http://, https:// for HTTP/REST, grpc://, grpcs:// for gRPC, tcp:// for TCP",
      "format": "uri",
      "examples": [
        "http://localhost:3000",
        "https://api.example.com",
        "grpc://localhost:50051",
        "grpcs://api.example.com:443",
        "tcp://localhost:9877"
      ]
    },
    "path": {
      "type": "string",
      "description": "Path to append to the base URL (HTTP only)",
      "default": "",
      "examples": [
        "/api/users",
        "/posts/123"
      ]
    },
    "method": {
      "type": "string",
      "description": "Protocol method for the request",
      "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS", "grpc", "tcp"],
      "default": "GET"
    },
    "content_type": {
      "type": "string",
      "description": "Content-Type header for the request (HTTP only, required when body or json is present)",
      "enum": ["application/json"],
      "examples": ["application/json"]
    },
    "body": {
      "type": "object",
      "description": "Request body as YAML structure (converted to JSON). Mutually exclusive with 'json' field.",
      "additionalProperties": true
    },
    "json": {
      "type": "string",
      "description": "Raw JSON literal for request body (HTTP only). Mutually exclusive with 'body' field.",
      "examples": [
        "{\n  \"id\": 123,\n  \"name\": \"example\"\n}"
      ]
    },
    "proto": {
      "type": "string",
      "description": "Proto file name (optional for gRPC, uses server reflection if omitted)",
      "examples": [
        "hello_world.proto",
        "api.proto"
      ]
    },
    "proto_path": {
      "type": "string",
      "description": "Directory containing proto files (optional for gRPC). Can be relative or absolute path. Required if proto is specified.",
      "examples": [
        "./proto",
        "../protos",
        "/path/to/protos"
      ]
    },
    "service": {
      "type": "string",
      "description": "Full gRPC service name (required for gRPC, format: package.ServiceName)",
      "examples": [
        "helloworld.Greeter",
        "api.v1.UserService"
      ]
    },
    "rpc": {
      "type": "string",
      "description": "RPC method name to call (required for gRPC)",
      "examples": [
        "SayHello",
        "GetUser",
        "CreatePost"
      ]
    },
    "plaintext": {
      "type": "boolean",
      "description": "Force plaintext/insecure mode for gRPC (optional, auto-detected from grpc:// scheme)",
      "default": false
    },
    "insecure": {
      "type": "boolean",
      "description": "Skip TLS certificate verification for gRPC (optional, for grpcs:// only)",
      "default": false
    },
    "metadata": {
      "type": "object",
      "description": "gRPC metadata (headers) as key-value pairs",
      "additionalProperties": {
        "type": "string"
      },
      "examples": [
        {
          "authorization": "Bearer token123",
          "request-id": "abc-123"
        }
      ]
    },
    "data": {
      "type": "string",
      "description": "Raw data to send over TCP connection (alternative to body for TCP)",
      "examples": [
        "Hello, server!\n",
        "GET / HTTP/1.1\r\n\r\n"
      ]
    },
    "encoding": {
      "type": "string",
      "description": "Encoding format for TCP data",
      "enum": ["text", "hex", "base64"],
      "default": "text"
    },
    "read_timeout": {
      "type": "number",
      "description": "Timeout in seconds for reading TCP response",
      "default": 5,
      "minimum": 1
    },
    "close_after_send": {
      "type": "boolean",
      "description": "Close TCP connection after sending data",
      "default": true
    },
    "jq_filter": {
      "type": "string",
      "description": "jq filter to apply to the response body"
    }
  },
  "allOf": [
    {
      "if": {
        "allOf": [
          {
            "anyOf": [
              { "required": ["body"] },
              { "required": ["json"] }
            ]
          },
          {
            "not": {
              "properties": {
                "url": {
                  "pattern": "^(grpcs?|tcp)://"
                }
              }
            }
          }
        ]
      },
      "then": {
        "required": ["content_type"]
      }
    },
    {
      "if": {
        "properties": {
          "url": {
            "pattern": "^grpcs?://"
          }
        }
      },
      "then": {
        "required": ["service", "rpc"],
        "properties": {
          "method": {
            "const": "grpc"
          }
        }
      },
      "else": {
        "if": {
          "properties": {
            "url": {
              "pattern": "^tcp://"
            }
          }
        },
        "then": {
          "properties": {
            "method": {
              "const": "tcp"
            }
          }
        },
        "else": {
          "required": ["method"],
          "properties": {
            "method": {
              "enum": ["GET", "POST", "PUT", "PATCH", "DELETE", "HEAD", "OPTIONS"]
            }
          }
        }
      }
    }
  ],
  "oneOf": [
    {
      "required": ["body"],
      "not": { "required": ["json"] }
    },
    {
      "required": ["json"],
      "not": { "required": ["body"] }
    },
    {
      "not": {
        "anyOf": [
          { "required": ["body"] },
          { "required": ["json"] }
        ]
      }
    }
  ],
  "examples": [
    {
      "url": "https://api.example.com",
      "path": "/users",
      "method": "GET"
    },
    {
      "url": "https://api.example.com",
      "path": "/users",
      "method": "POST",
      "content_type": "application/json",
      "body": {
        "name": "John Doe",
        "email": "john@example.com"
      }
    },
    {
      "url": "https://api.example.com",
      "path": "/data",
      "method": "POST",
      "content_type": "application/json",
      "json": "{\n  \"id\": 123,\n  \"status\": \"active\"\n}"
    },
    {
      "url": "grpc://localhost:50051",
      "method": "grpc",
      "proto": "hello_world.proto",
      "proto_path": "./proto",
      "service": "helloworld.Greeter",
      "rpc": "SayHello",
      "body": {
        "name": "World"
      }
    },
    {
      "url": "tcp://localhost:9877",
      "method": "tcp",
      "body": {
        "type": "get_session_info",
        "params": {}
      },
      "read_timeout": 5,
      "close_after_send": true
    }
  ]
}
